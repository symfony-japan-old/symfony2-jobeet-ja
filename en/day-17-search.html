
<!DOCTYPE html>


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>36. Day 17: Search &mdash; Symfony2 Jobeet 0.0.1 documentation</title>
    
    <link rel="stylesheet" href="../_static/basic.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/bootstrap-3.2.0/css/bootstrap.min.css" type="text/css" />
    <link rel="stylesheet" href="../_static/bootstrap-3.2.0/css/bootstrap-theme.min.css" type="text/css" />
    <link rel="stylesheet" href="../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../_static/my-styles.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="../_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="../_static/bootstrap-3.2.0/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../_static/bootstrap-sphinx.js"></script>
    <link rel="top" title="Symfony2 Jobeet 0.0.1 documentation" href="../index.html" />
    <link rel="next" title="37. Day 18: AJAX" href="day-18-ajax.html" />
    <link rel="prev" title="35. Day 16: The Mailer" href="day-16-the-mailer.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">

  </head>
  <body>

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../index.html">
          Symfony2 Jobeet</a>
        <span class="navbar-text navbar-version pull-left"><b>0.0.1</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            <li class="divider-vertical"></li>
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../day-1-starting-up-the-project.html">1. 1日目: プロジェクトを始める</a></li>
<li class="toctree-l1"><a class="reference internal" href="../day-2-the-project.html">2. 2日目: このプロジェクトについて</a></li>
<li class="toctree-l1"><a class="reference internal" href="../day-3-the-data-model.html">3. 3日目: データモデル</a></li>
<li class="toctree-l1"><a class="reference internal" href="../day-4-the-controller-and-the-view.html">4. 4日目: コントローラーとビュー</a></li>
<li class="toctree-l1"><a class="reference internal" href="../day-5-the-routing.html">5. 5日目: ルーティング</a></li>
<li class="toctree-l1"><a class="reference internal" href="../day-6-more-with-the-model.html">6. 6日目: モデルの続き</a></li>
<li class="toctree-l1"><a class="reference internal" href="../day-7-playing-with-the-category-page.html">7. 7日目: カテゴリーページ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../day-8-the-unit-tests.html">8. 8日目: 単体テスト(ユニットテスト)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../day-9-the-functional-tests.html">9. 9日目: 機能テスト(ファンクショナルテスト)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../day-10-the-forms.html">10. 10日目: フォーム</a></li>
<li class="toctree-l1"><a class="reference internal" href="../day-11-testing-your-forms.html">11. 11日目: フォームのテスト</a></li>
<li class="toctree-l1"><a class="reference internal" href="../day-12-sonata-admin-bundle.html">12. 12日目: Sonata Admin Bundle</a></li>
<li class="toctree-l1"><a class="reference internal" href="../day-13-security.html">13. 13日目: セキュリティ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../day-14-feeds.html">14. 14日目: フィード</a></li>
<li class="toctree-l1"><a class="reference internal" href="../day-15-web-services.html">15. 15日目: ウェブサービス</a></li>
<li class="toctree-l1"><a class="reference internal" href="../day-16-the-mailer.html">16. 16日目: メール送信</a></li>
<li class="toctree-l1"><a class="reference internal" href="../day-17-search.html">17. 17日目: 検索</a></li>
<li class="toctree-l1"><a class="reference internal" href="../day-18-ajax.html">18. 18日目: AJAX</a></li>
<li class="toctree-l1"><a class="reference internal" href="../day-19-internationalization-and-localization.html">19. 19日目: 国際化と地域化</a></li>
<li class="toctree-l1"><a class="reference internal" href="day-1-starting-up-the-project.html">20. Day 1: Starting up the Project</a></li>
<li class="toctree-l1"><a class="reference internal" href="day-2-the-project.html">21. Day 2: The Project</a></li>
<li class="toctree-l1"><a class="reference internal" href="day-3-the-data-model.html">22. Day 3: The Data Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="day-4-the-controller-and-the-view.html">23. Day 4: The Controller and the View</a></li>
<li class="toctree-l1"><a class="reference internal" href="day-5-the-routing.html">24. Day 5: The Routing</a></li>
<li class="toctree-l1"><a class="reference internal" href="day-6-more-with-the-model.html">25. Day 6: More with the Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="day-7-playing-with-the-category-page.html">26. Day 7: Playing with the Category page</a></li>
<li class="toctree-l1"><a class="reference internal" href="day-8-the-unit-tests.html">27. Day 8: The Unit Tests</a></li>
<li class="toctree-l1"><a class="reference internal" href="day-9-the-functional-tests.html">28. Day 9: The functional Tests</a></li>
<li class="toctree-l1"><a class="reference internal" href="day-10-the-forms.html">29. Day 10: The Forms</a></li>
<li class="toctree-l1"><a class="reference internal" href="day-11-testing-your-forms.html">30. Day 11: Testing your Forms</a></li>
<li class="toctree-l1"><a class="reference internal" href="day-12-sonata-admin-bundle.html">31. Day 12: Sonata Admin Bundle</a></li>
<li class="toctree-l1"><a class="reference internal" href="day-13-security.html">32. Day 13: Security</a></li>
<li class="toctree-l1"><a class="reference internal" href="day-14-feeds.html">33. Day 14: Feeds</a></li>
<li class="toctree-l1"><a class="reference internal" href="day-15-web-services.html">34. Day 15: Web Services</a></li>
<li class="toctree-l1"><a class="reference internal" href="day-16-the-mailer.html">35. Day 16: The Mailer</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="">36. Day 17: Search</a></li>
<li class="toctree-l1"><a class="reference internal" href="day-18-ajax.html">37. Day 18: AJAX</a></li>
<li class="toctree-l1"><a class="reference internal" href="day-19-internationalization-and-localization.html">38. Day 19: Internationalization and Localization</a></li>
</ul>
</ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"><ul>
<li><a class="reference internal" href="#">36. Day 17: Search</a><ul>
<li><a class="reference internal" href="#the-technology">36.1. The Technology</a></li>
<li><a class="reference internal" href="#installing-and-configuring-the-zend-framework">36.2. Installing and Configuring the Zend Framework</a></li>
<li><a class="reference internal" href="#indexing">36.3. Indexing</a></li>
<li><a class="reference internal" href="#the-search">36.4. The Search</a></li>
<li><a class="reference internal" href="#unit-tests">36.5. Unit Tests</a></li>
<li><a class="reference internal" href="#tasks">36.6. Tasks</a></li>
</ul>
</li>
</ul>
</ul>
</li>
              
            
            
              
                
  <li>
    <a href="day-16-the-mailer.html" title="Previous Chapter: 35. Day 16: The Mailer"><span class="glyphicon glyphicon-chevron-left visible-sm"></span><span class="hidden-sm">&laquo; 35. Day 16: The ...</span>
    </a>
  </li>
  <li>
    <a href="day-18-ajax.html" title="Next Chapter: 37. Day 18: AJAX"><span class="glyphicon glyphicon-chevron-right visible-sm"></span><span class="hidden-sm">37. Day 18: AJAX &raquo;</span>
    </a>
  </li>
              
            
            
            
            
              <li class="hidden-sm">
<div id="sourcelink">
  <a href="../_sources/en/day-17-search.txt"
     rel="nofollow">Source</a>
</div></li>
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="col-md-12">
      
  <div class="section" id="day-17-search">
<h1>36. Day 17: Search<a class="headerlink" href="#day-17-search" title="Permalink to this headline">¶</a></h1>
<ul class="simple">
<li>This article is part of the original <a class="reference external" href="http://symfony.com/legacy/doc/jobeet?orm=Doctrine">Jobeet Tutorial</a>, created by Fabien Potencier, for Symfony 1.4.</li>
</ul>
<p>In day 14, we added some feeds to keep Jobeet users up-to-date with new job posts. Today will help you to improve the user experience by implementing the latest main feature of the Jobeet website: the search engine.</p>
<div class="section" id="the-technology">
<h2>36.1. The Technology<a class="headerlink" href="#the-technology" title="Permalink to this headline">¶</a></h2>
<p>Today, we want to add a search engine to Jobeet, and the Zend Framework provides a great library, called Zend Lucene, which is a port of the well-know Java Lucene project. Instead of creating yet another search engine for Jobeet, which is quite a complex task, we will use Zend Lucene.
Today is not a tutorial about the Zend Lucene library, but how to integrate it into the Jobeet website; or more generally, how to integrate third-party libraries into a symfony project. If you want more information about this technology, please refer to the Zend Lucene documentation.</p>
</div>
<div class="section" id="installing-and-configuring-the-zend-framework">
<h2>36.2. Installing and Configuring the Zend Framework<a class="headerlink" href="#installing-and-configuring-the-zend-framework" title="Permalink to this headline">¶</a></h2>
<p>The Zend Lucene library is part of the Zend Framework. We will only install the Zend Framework into the vendor/ directory, alongside the symfony framework itself.
First, download the Zend Framework and unzip the files so that you have a vendor/Zend/directory. Keep in mind that the 2.*  versions of Zend Framework do not have Lucene library integrated, so don’t download any of them for this tutorial.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The following explanations have been tested with the 1.12.3 version of the Zend Framework.</p>
</div>
<img alt="../_images/Day-17-zend.jpg" src="../_images/Day-17-zend.jpg" />
<p>You can clean up the directory by removing everything but the following files and directories:</p>
<ul class="simple">
<li>Exception.php</li>
<li>Loader/</li>
<li>Loader.php</li>
<li>Search/</li>
</ul>
<p>Then, add the following code to the autoload.php file to provide a simple way to register the Zend autoloader.</p>
<p>app/autoload.php</p>
<div class="highlight-php"><div class="highlight"><pre><span class="c1">// ...</span>

<span class="nb">set_include_path</span><span class="p">(</span><span class="nx">__DIR__</span><span class="o">.</span><span class="s1">&#39;/../vendor&#39;</span><span class="o">.</span><span class="nx">PATH_SEPARATOR</span><span class="o">.</span><span class="nb">get_include_path</span><span class="p">());</span>
<span class="k">require_once</span> <span class="nx">__DIR__</span><span class="o">.</span><span class="s1">&#39;/../vendor/Zend/Loader/Autoloader.php&#39;</span><span class="p">;</span>
<span class="nx">Zend_Loader_Autoloader</span><span class="o">::</span><span class="na">getInstance</span><span class="p">();</span>

<span class="k">return</span> <span class="nv">$loader</span><span class="p">;</span>
</pre></div>
</div>
</div>
<div class="section" id="indexing">
<h2>36.3. Indexing<a class="headerlink" href="#indexing" title="Permalink to this headline">¶</a></h2>
<p>The Jobeet search engine should be able to return all jobs matching keywords entered by the user. Before being able to search anything, an index has to be built for the jobs; for Jobeet, it will be stored in a new directory you will create, /web/data/ .
Zend Lucene provides two methods to retrieve an index depending whether one already exists or not. Let’s create helper methods in the Job entity class that returns an existing index or creates a new one for us:</p>
<p>src/Ibw/JobeetBundle/Entity/Job.php</p>
<div class="highlight-php"><div class="highlight"><pre><span class="c1">// ...</span>

<span class="k">class</span> <span class="nc">Job</span>
<span class="p">{</span>
    <span class="c1">// ...</span>

    <span class="k">static</span> <span class="k">public</span> <span class="k">function</span> <span class="nf">getLuceneIndex</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">file_exists</span><span class="p">(</span><span class="nv">$index</span> <span class="o">=</span> <span class="nx">self</span><span class="o">::</span><span class="na">getLuceneIndexFile</span><span class="p">()))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">\Zend_Search_Lucene</span><span class="o">::</span><span class="na">open</span><span class="p">(</span><span class="nv">$index</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nx">\Zend_Search_Lucene</span><span class="o">::</span><span class="na">create</span><span class="p">(</span><span class="nv">$index</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">static</span> <span class="k">public</span> <span class="k">function</span> <span class="nf">getLuceneIndexFile</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nx">__DIR__</span><span class="o">.</span><span class="s1">&#39;/../../../../web/data/job.index&#39;</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Each time a job is created or updated, the index must be updated. Edit the ORM file to update the index whenever a job is serialized to the database:</p>
<p>src/Ibw/JobeetBundle/Resources/config/doctrine/Job.orm.yml</p>
<div class="highlight-yaml"><div class="highlight"><pre><span class="c1"># ...</span>
    <span class="c1"># ...</span>
    <span class="l-Scalar-Plain">lifecycleCallbacks</span><span class="p-Indicator">:</span>
        <span class="c1"># ...</span>
        <span class="l-Scalar-Plain">postPersist</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span> <span class="nv">upload</span><span class="p-Indicator">,</span> <span class="nv">updateLuceneIndex</span> <span class="p-Indicator">]</span>
        <span class="l-Scalar-Plain">postUpdate</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span> <span class="nv">upload</span><span class="p-Indicator">,</span> <span class="nv">updateLuceneIndex</span> <span class="p-Indicator">]</span>
        <span class="c1"># ...</span>
</pre></div>
</div>
<p>Now, run the generate:entities command, so that the updateLuceneIndex() method to be generated by Doctrine inside the Job class:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>php app/console doctrine:generate:entities IbwJobeetBundle
</pre></div>
</div>
<p>Then, edit the updateLuceneIndex() method that does the actual work:</p>
<p>src/Ibw/JobeetBundle/Entity/Job.php</p>
<div class="highlight-php"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Job</span>
<span class="p">{</span>
    <span class="c1">// ...</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">updateLuceneIndex</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$index</span> <span class="o">=</span> <span class="nx">self</span><span class="o">::</span><span class="na">getLuceneIndex</span><span class="p">();</span>

        <span class="c1">// remove existing entries</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$index</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">(</span><span class="s1">&#39;pk:&#39;</span><span class="o">.</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getId</span><span class="p">())</span> <span class="k">as</span> <span class="nv">$hit</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="nv">$index</span><span class="o">-&gt;</span><span class="na">delete</span><span class="p">(</span><span class="nv">$hit</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="c1">// don&#39;t index expired and non-activated jobs</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">isExpired</span><span class="p">()</span> <span class="o">||</span> <span class="o">!</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getIsActivated</span><span class="p">())</span>
        <span class="p">{</span>
          <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nv">$doc</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">\Zend_Search_Lucene_Document</span><span class="p">();</span>

        <span class="c1">// store job primary key to identify it in the search results</span>
        <span class="nv">$doc</span><span class="o">-&gt;</span><span class="na">addField</span><span class="p">(</span><span class="nx">\Zend_Search_Lucene_Field</span><span class="o">::</span><span class="na">Keyword</span><span class="p">(</span><span class="s1">&#39;pk&#39;</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getId</span><span class="p">()));</span>

        <span class="c1">// index job fields</span>
        <span class="nv">$doc</span><span class="o">-&gt;</span><span class="na">addField</span><span class="p">(</span><span class="nx">\Zend_Search_Lucene_Field</span><span class="o">::</span><span class="na">UnStored</span><span class="p">(</span><span class="s1">&#39;position&#39;</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getPosition</span><span class="p">(),</span> <span class="s1">&#39;utf-8&#39;</span><span class="p">));</span>
        <span class="nv">$doc</span><span class="o">-&gt;</span><span class="na">addField</span><span class="p">(</span><span class="nx">\Zend_Search_Lucene_Field</span><span class="o">::</span><span class="na">UnStored</span><span class="p">(</span><span class="s1">&#39;company&#39;</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getCompany</span><span class="p">(),</span> <span class="s1">&#39;utf-8&#39;</span><span class="p">));</span>
        <span class="nv">$doc</span><span class="o">-&gt;</span><span class="na">addField</span><span class="p">(</span><span class="nx">\Zend_Search_Lucene_Field</span><span class="o">::</span><span class="na">UnStored</span><span class="p">(</span><span class="s1">&#39;location&#39;</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getLocation</span><span class="p">(),</span> <span class="s1">&#39;utf-8&#39;</span><span class="p">));</span>
        <span class="nv">$doc</span><span class="o">-&gt;</span><span class="na">addField</span><span class="p">(</span><span class="nx">\Zend_Search_Lucene_Field</span><span class="o">::</span><span class="na">UnStored</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getDescription</span><span class="p">(),</span> <span class="s1">&#39;utf-8&#39;</span><span class="p">));</span>

        <span class="c1">// add job to the index</span>
        <span class="nv">$index</span><span class="o">-&gt;</span><span class="na">addDocument</span><span class="p">(</span><span class="nv">$doc</span><span class="p">);</span>
        <span class="nv">$index</span><span class="o">-&gt;</span><span class="na">commit</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>As Zend Lucene is not able to update an existing entry, it is removed first if the job already exists in the index.
Indexing the job itself is simple: the primary key is stored for future reference when searching jobs and the main columns (position, company, location, and description) are indexed but not stored in the index as we will use the real objects to display the results.
We also need create a deleteLuceneIndex() method to remove the entry of the deleted job from the index. As we did for the update, we will do for delete. Start by adding the deleteLuceneIndex() method to postRemove section of the ORM file:</p>
<p>src/Ibw/JobeetBundle/Resources/config/doctrine/Job.orm.yml</p>
<div class="highlight-yaml"><div class="highlight"><pre><span class="c1"># ...</span>
    <span class="c1"># ...</span>
    <span class="l-Scalar-Plain">lifecycleCallbacks</span><span class="p-Indicator">:</span>
        <span class="c1"># ...</span>
        <span class="l-Scalar-Plain">postRemove</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span> <span class="nv">removeUpload</span><span class="p-Indicator">,</span> <span class="nv">deleteLuceneIndex</span> <span class="p-Indicator">]</span>
</pre></div>
</div>
<p>Again, run the command for generating entities.
Now, go to entity file and implement the deleteLuceneIndex() method:</p>
<p>src/Ibw/JobeetBundle/Entity/Job.php</p>
<div class="highlight-php"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Job</span>
<span class="p">{</span>
    <span class="c1">// ...</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">deleteLuceneIndex</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$index</span> <span class="o">=</span> <span class="nx">self</span><span class="o">::</span><span class="na">getLuceneIndex</span><span class="p">();</span>

        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$index</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">(</span><span class="s1">&#39;pk:&#39;</span><span class="o">.</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getId</span><span class="p">())</span> <span class="k">as</span> <span class="nv">$hit</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$index</span><span class="o">-&gt;</span><span class="na">delete</span><span class="p">(</span><span class="nv">$hit</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>As the index is modified from the command line and also from the web, you must change the index directory permissions accordingly depending on your configuration:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>chmod -R 777 web/data
</pre></div>
</div>
<p>Now that we have everything in place, you can reload the fixture data to index them:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>php app/console doctrine:fixtures:load
</pre></div>
</div>
</div>
<div class="section" id="the-search">
<h2>36.4. The Search<a class="headerlink" href="#the-search" title="Permalink to this headline">¶</a></h2>
<p>Implementing the search is a piece of cake. First, create a route:</p>
<p>wrc/Ibw/JobeetBundle/Resources/config/routing/job.yml</p>
<div class="highlight-yaml"><div class="highlight"><pre><span class="c1"># ...</span>

<span class="l-Scalar-Plain">ibw_job_search</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">pattern</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">/search</span>
    <span class="l-Scalar-Plain">defaults</span><span class="p-Indicator">:</span> <span class="p-Indicator">{</span> <span class="nv">_controller</span><span class="p-Indicator">:</span> <span class="s">&quot;IbwJobeetBundle:Job:search&quot;</span> <span class="p-Indicator">}</span>
</pre></div>
</div>
<p>And the corresponding action:</p>
<p>src/Ibw/JobeetBundle/Controller/JobController.php</p>
<div class="highlight-php"><div class="highlight"><pre><span class="k">namespace</span> <span class="nx">Ibw\JobeetBundle\Controller</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Symfony\Component\HttpFoundation\Request</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Bundle\FrameworkBundle\Controller\Controller</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Ibw\JobeetBundle\Entity\Job</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Ibw\JobeetBundle\Form\JobType</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">JobController</span> <span class="k">extends</span> <span class="nx">Controller</span>
<span class="p">{</span>
    <span class="c1">// ...</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">searchAction</span><span class="p">(</span><span class="nx">Request</span> <span class="nv">$request</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$em</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getDoctrine</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">getManager</span><span class="p">();</span>
        <span class="nv">$query</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getRequest</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;query&#39;</span><span class="p">);</span>

        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nv">$query</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">redirect</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">generateUrl</span><span class="p">(</span><span class="s1">&#39;ibw_job&#39;</span><span class="p">));</span>
        <span class="p">}</span>

        <span class="nv">$jobs</span> <span class="o">=</span> <span class="nv">$em</span><span class="o">-&gt;</span><span class="na">getRepository</span><span class="p">(</span><span class="s1">&#39;IbwJobeetBundle:Job&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">getForLuceneQuery</span><span class="p">(</span><span class="nv">$query</span><span class="p">);</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">render</span><span class="p">(</span><span class="s1">&#39;IbwJobeetBundle:Job:search.html.twig&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;jobs&#39;</span> <span class="o">=&gt;</span> <span class="nv">$jobs</span><span class="p">));</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Inside the searcAction(), the user is forwarded to the index action of the JobController if the query request does not exist or is empty.
The template is also quite straightforward:</p>
<p>src/Ibw/JobeetBundle/Resources/views/Job/search.html.twig</p>
<div class="highlight-html+jinja"><div class="highlight"><pre><span class="cp">{%</span> <span class="k">extends</span> <span class="s1">&#39;IbwJobeetBundle::layout.html.twig&#39;</span> <span class="cp">%}</span>

<span class="cp">{%</span> <span class="k">block</span> <span class="nv">stylesheets</span> <span class="cp">%}</span>
    <span class="cp">{{</span> <span class="nv">parent</span><span class="o">()</span> <span class="cp">}}</span>
    <span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span> <span class="na">href=</span><span class="s">&quot;</span><span class="cp">{{</span> <span class="nv">asset</span><span class="o">(</span><span class="s1">&#39;bundles/ibwjobeet/css/jobs.css&#39;</span><span class="o">)</span> <span class="cp">}}</span><span class="s">&quot;</span> <span class="na">type=</span><span class="s">&quot;text/css&quot;</span> <span class="na">media=</span><span class="s">&quot;all&quot;</span> <span class="nt">/&gt;</span>
<span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span>

<span class="cp">{%</span> <span class="k">block</span> <span class="nv">content</span> <span class="cp">%}</span>
    <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;jobs&quot;</span><span class="nt">&gt;</span>
        <span class="cp">{%</span> <span class="k">include</span> <span class="s1">&#39;IbwJobeetBundle:Job:list.html.twig&#39;</span> <span class="k">with</span> <span class="o">{</span><span class="s1">&#39;jobs&#39;</span><span class="o">:</span> <span class="nv">jobs</span><span class="o">}</span> <span class="cp">%}</span>
    <span class="nt">&lt;/div&gt;</span>
<span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span>
</pre></div>
</div>
<p>The search itself is delegated to the getForLuceneQuery() method:</p>
<p>src/Ibw/JobeetBundle/Repository/JobRepository.php</p>
<div class="highlight-php"><div class="highlight"><pre><span class="k">namespace</span> <span class="nx">Ibw\JobeetBundle\Repository</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Doctrine\ORM\EntityRepository</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Ibw\JobeetBundle\Entity\Job</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">JobRepository</span> <span class="k">extends</span> <span class="nx">EntityRepository</span>
<span class="p">{</span>
    <span class="c1">// ...</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getForLuceneQuery</span><span class="p">(</span><span class="nv">$query</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$hits</span> <span class="o">=</span> <span class="nx">Job</span><span class="o">::</span><span class="na">getLuceneIndex</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">(</span><span class="nv">$query</span><span class="p">);</span>

        <span class="nv">$pks</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$hits</span> <span class="k">as</span> <span class="nv">$hit</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="nv">$pks</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$hit</span><span class="o">-&gt;</span><span class="na">pk</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$pks</span><span class="p">))</span>
        <span class="p">{</span>
          <span class="k">return</span> <span class="k">array</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="nv">$q</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">createQueryBuilder</span><span class="p">(</span><span class="s1">&#39;j&#39;</span><span class="p">)</span>
            <span class="o">-&gt;</span><span class="na">where</span><span class="p">(</span><span class="s1">&#39;j.id IN (:pks)&#39;</span><span class="p">)</span>
            <span class="o">-&gt;</span><span class="na">setParameter</span><span class="p">(</span><span class="s1">&#39;pks&#39;</span><span class="p">,</span> <span class="nv">$pks</span><span class="p">)</span>
            <span class="o">-&gt;</span><span class="na">andWhere</span><span class="p">(</span><span class="s1">&#39;j.is_activated = :active&#39;</span><span class="p">)</span>
            <span class="o">-&gt;</span><span class="na">setParameter</span><span class="p">(</span><span class="s1">&#39;active&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="o">-&gt;</span><span class="na">setMaxResults</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
            <span class="o">-&gt;</span><span class="na">getQuery</span><span class="p">();</span>

        <span class="k">return</span> <span class="nv">$q</span><span class="o">-&gt;</span><span class="na">getResult</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>After we get all results from the Lucene index, we filter out the inactive jobs, and limit the number of results to 20.
To make it work, update the layout:</p>
<div class="highlight-html+jinja"><div class="highlight"><pre><span class="c">&lt;!-- ... --&gt;</span>
    <span class="c">&lt;!-- ... --&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;search&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;h2&gt;</span>Ask for a job<span class="nt">&lt;/h2&gt;</span>
            <span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">&quot;</span><span class="cp">{{</span> <span class="nv">path</span><span class="o">(</span><span class="s1">&#39;ibw_job_search&#39;</span><span class="o">)</span> <span class="cp">}}</span><span class="s">&quot;</span> <span class="na">method=</span><span class="s">&quot;get&quot;</span><span class="nt">&gt;</span>
                <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="na">name=</span><span class="s">&quot;query&quot;</span> <span class="na">value=</span><span class="s">&quot;</span><span class="cp">{{</span> <span class="nv">app.request.get</span><span class="o">(</span><span class="s1">&#39;query&#39;</span><span class="o">)</span> <span class="cp">}}</span><span class="s">&quot;</span> <span class="na">id=</span><span class="s">&quot;search_keywords&quot;</span> <span class="nt">/&gt;</span>
                <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">value=</span><span class="s">&quot;search&quot;</span> <span class="nt">/&gt;</span>
                <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;help&quot;</span><span class="nt">&gt;</span>
                    Enter some keywords (city, country, position, ...)
                <span class="nt">&lt;/div&gt;</span>
            <span class="nt">&lt;/form&gt;</span>
        <span class="nt">&lt;/div&gt;</span>
    <span class="c">&lt;!-- ... --&gt;</span>
<span class="c">&lt;!-- ... --&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="unit-tests">
<h2>36.5. Unit Tests<a class="headerlink" href="#unit-tests" title="Permalink to this headline">¶</a></h2>
<p>What kind of unit tests do we need to create to test the search engine? We obviously won’t test the Zend Lucene library itself, but its integration with the Job class.
Add the following test at the end of the JobRepositoryTest.php file:</p>
<p>src/Ibw/JobeetBundle/Tests/Repository/JobRepositoryTest.php</p>
<div class="highlight-php"><div class="highlight"><pre><span class="c1">// ...</span>
<span class="k">use</span> <span class="nx">Ibw\JobeetBundle\Entity\Job</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">JobRepositoryTest</span> <span class="k">extends</span> <span class="nx">WebTestCase</span>
<span class="p">{</span>
    <span class="c1">// ...</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">testGetForLuceneQuery</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$em</span> <span class="o">=</span> <span class="k">static</span><span class="o">::</span><span class="nv">$kernel</span><span class="o">-&gt;</span><span class="na">getContainer</span><span class="p">()</span>
            <span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;doctrine&#39;</span><span class="p">)</span>
            <span class="o">-&gt;</span><span class="na">getManager</span><span class="p">();</span>

        <span class="nv">$job</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Job</span><span class="p">();</span>
        <span class="nv">$job</span><span class="o">-&gt;</span><span class="na">setType</span><span class="p">(</span><span class="s1">&#39;part-time&#39;</span><span class="p">);</span>
        <span class="nv">$job</span><span class="o">-&gt;</span><span class="na">setCompany</span><span class="p">(</span><span class="s1">&#39;Sensio&#39;</span><span class="p">);</span>
        <span class="nv">$job</span><span class="o">-&gt;</span><span class="na">setPosition</span><span class="p">(</span><span class="s1">&#39;FOO6&#39;</span><span class="p">);</span>
        <span class="nv">$job</span><span class="o">-&gt;</span><span class="na">setLocation</span><span class="p">(</span><span class="s1">&#39;Paris&#39;</span><span class="p">);</span>
        <span class="nv">$job</span><span class="o">-&gt;</span><span class="na">setDescription</span><span class="p">(</span><span class="s1">&#39;WebDevelopment&#39;</span><span class="p">);</span>
        <span class="nv">$job</span><span class="o">-&gt;</span><span class="na">setHowToApply</span><span class="p">(</span><span class="s1">&#39;Send resumee&#39;</span><span class="p">);</span>
        <span class="nv">$job</span><span class="o">-&gt;</span><span class="na">setEmail</span><span class="p">(</span><span class="s1">&#39;jobeet@example.com&#39;</span><span class="p">);</span>
        <span class="nv">$job</span><span class="o">-&gt;</span><span class="na">setUrl</span><span class="p">(</span><span class="s1">&#39;http://sensio-labs.com&#39;</span><span class="p">);</span>
        <span class="nv">$job</span><span class="o">-&gt;</span><span class="na">setIsActivated</span><span class="p">(</span><span class="k">false</span><span class="p">);</span>

        <span class="nv">$em</span><span class="o">-&gt;</span><span class="na">persist</span><span class="p">(</span><span class="nv">$job</span><span class="p">);</span>
        <span class="nv">$em</span><span class="o">-&gt;</span><span class="na">flush</span><span class="p">();</span>

        <span class="nv">$jobs</span> <span class="o">=</span> <span class="nv">$em</span><span class="o">-&gt;</span><span class="na">getRepository</span><span class="p">(</span><span class="s1">&#39;IbwJobeetBundle:Job&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">getForLuceneQuery</span><span class="p">(</span><span class="s1">&#39;FOO6&#39;</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertEquals</span><span class="p">(</span><span class="nb">count</span><span class="p">(</span><span class="nv">$jobs</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>

        <span class="nv">$job</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Job</span><span class="p">();</span>
        <span class="nv">$job</span><span class="o">-&gt;</span><span class="na">setType</span><span class="p">(</span><span class="s1">&#39;part-time&#39;</span><span class="p">);</span>
        <span class="nv">$job</span><span class="o">-&gt;</span><span class="na">setCompany</span><span class="p">(</span><span class="s1">&#39;Sensio&#39;</span><span class="p">);</span>
        <span class="nv">$job</span><span class="o">-&gt;</span><span class="na">setPosition</span><span class="p">(</span><span class="s1">&#39;FOO7&#39;</span><span class="p">);</span>
        <span class="nv">$job</span><span class="o">-&gt;</span><span class="na">setLocation</span><span class="p">(</span><span class="s1">&#39;Paris&#39;</span><span class="p">);</span>
        <span class="nv">$job</span><span class="o">-&gt;</span><span class="na">setDescription</span><span class="p">(</span><span class="s1">&#39;WebDevelopment&#39;</span><span class="p">);</span>
        <span class="nv">$job</span><span class="o">-&gt;</span><span class="na">setHowToApply</span><span class="p">(</span><span class="s1">&#39;Send resumee&#39;</span><span class="p">);</span>
        <span class="nv">$job</span><span class="o">-&gt;</span><span class="na">setEmail</span><span class="p">(</span><span class="s1">&#39;jobeet@example.com&#39;</span><span class="p">);</span>
        <span class="nv">$job</span><span class="o">-&gt;</span><span class="na">setUrl</span><span class="p">(</span><span class="s1">&#39;http://sensio-labs.com&#39;</span><span class="p">);</span>
        <span class="nv">$job</span><span class="o">-&gt;</span><span class="na">setIsActivated</span><span class="p">(</span><span class="k">true</span><span class="p">);</span>

        <span class="nv">$em</span><span class="o">-&gt;</span><span class="na">persist</span><span class="p">(</span><span class="nv">$job</span><span class="p">);</span>
        <span class="nv">$em</span><span class="o">-&gt;</span><span class="na">flush</span><span class="p">();</span>

        <span class="nv">$jobs</span> <span class="o">=</span> <span class="nv">$em</span><span class="o">-&gt;</span><span class="na">getRepository</span><span class="p">(</span><span class="s1">&#39;IbwJobeetBundle:Job&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">getForLuceneQuery</span><span class="p">(</span><span class="s1">&#39;position:FOO7&#39;</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertEquals</span><span class="p">(</span><span class="nb">count</span><span class="p">(</span><span class="nv">$jobs</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$jobs</span> <span class="k">as</span> <span class="nv">$job_rep</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertEquals</span><span class="p">(</span><span class="nv">$job_rep</span><span class="o">-&gt;</span><span class="na">getId</span><span class="p">(),</span> <span class="nv">$job</span><span class="o">-&gt;</span><span class="na">getId</span><span class="p">());</span>
        <span class="p">}</span>

        <span class="nv">$em</span><span class="o">-&gt;</span><span class="na">remove</span><span class="p">(</span><span class="nv">$job</span><span class="p">);</span>
        <span class="nv">$em</span><span class="o">-&gt;</span><span class="na">flush</span><span class="p">();</span>

        <span class="nv">$jobs</span> <span class="o">=</span> <span class="nv">$em</span><span class="o">-&gt;</span><span class="na">getRepository</span><span class="p">(</span><span class="s1">&#39;IbwJobeetBundle:Job&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">getForLuceneQuery</span><span class="p">(</span><span class="s1">&#39;position:FOO7&#39;</span><span class="p">);</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertEquals</span><span class="p">(</span><span class="nb">count</span><span class="p">(</span><span class="nv">$jobs</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>We test that a non activated job, or a deleted one does not show up in the search results; we also check that jobs matching the given criteria do show up in the results.</p>
</div>
<div class="section" id="tasks">
<h2>36.6. Tasks<a class="headerlink" href="#tasks" title="Permalink to this headline">¶</a></h2>
<p>Eventually, we need to update the JobeetCleanup task to cleanup the index from stale entries (when a job expires for example) and optimize the index from time to time:</p>
<p>src/Ibw/JobeetBundle/Command/JobeetCleanupCommand.php</p>
<div class="highlight-php"><div class="highlight"><pre><span class="c1">// ...</span>
<span class="k">use</span>  <span class="nx">Ibw\JobeetBundle\Entity\Job</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">JobeetCleanupCommand</span> <span class="k">extends</span> <span class="nx">ContainerAwareCommand</span>
<span class="p">{</span>
    <span class="c1">// ...</span>

    <span class="k">protected</span> <span class="k">function</span> <span class="nf">execute</span><span class="p">(</span><span class="nx">InputInterface</span> <span class="nv">$input</span><span class="p">,</span> <span class="nx">OutputInterface</span> <span class="nv">$output</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$days</span> <span class="o">=</span> <span class="nv">$input</span><span class="o">-&gt;</span><span class="na">getArgument</span><span class="p">(</span><span class="s1">&#39;days&#39;</span><span class="p">);</span>

        <span class="nv">$em</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getContainer</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;doctrine&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">getManager</span><span class="p">();</span>

        <span class="c1">// cleanup Lucene index</span>
        <span class="nv">$index</span> <span class="o">=</span> <span class="nx">Job</span><span class="o">::</span><span class="na">getLuceneIndex</span><span class="p">();</span>

        <span class="nv">$q</span> <span class="o">=</span> <span class="nv">$em</span><span class="o">-&gt;</span><span class="na">getRepository</span><span class="p">(</span><span class="s1">&#39;IbwJobeetBundle:Job&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">createQueryBuilder</span><span class="p">(</span><span class="s1">&#39;j&#39;</span><span class="p">)</span>
          <span class="o">-&gt;</span><span class="na">where</span><span class="p">(</span><span class="s1">&#39;j.expires_at &lt; :date&#39;</span><span class="p">)</span>
          <span class="o">-&gt;</span><span class="na">setParameter</span><span class="p">(</span><span class="s1">&#39;date&#39;</span><span class="p">,</span><span class="nb">date</span><span class="p">(</span><span class="s1">&#39;Y-m-d&#39;</span><span class="p">))</span>
          <span class="o">-&gt;</span><span class="na">getQuery</span><span class="p">();</span>

        <span class="nv">$jobs</span> <span class="o">=</span> <span class="nv">$q</span><span class="o">-&gt;</span><span class="na">getResult</span><span class="p">();</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$jobs</span> <span class="k">as</span> <span class="nv">$job</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nv">$hit</span> <span class="o">=</span> <span class="nv">$index</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">(</span><span class="s1">&#39;pk:&#39;</span><span class="o">.</span><span class="nv">$job</span><span class="o">-&gt;</span><span class="na">getId</span><span class="p">()))</span>
          <span class="p">{</span>
            <span class="nv">$index</span><span class="o">-&gt;</span><span class="na">delete</span><span class="p">(</span><span class="nv">$hit</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">}</span>

        <span class="nv">$index</span><span class="o">-&gt;</span><span class="na">optimize</span><span class="p">();</span>

        <span class="nv">$output</span><span class="o">-&gt;</span><span class="na">writeln</span><span class="p">(</span><span class="s1">&#39;Cleaned up and optimized the job index&#39;</span><span class="p">);</span>

        <span class="c1">// Remove stale jobs</span>
        <span class="nv">$nb</span> <span class="o">=</span> <span class="nv">$em</span><span class="o">-&gt;</span><span class="na">getRepository</span><span class="p">(</span><span class="s1">&#39;IbwJobeetBundle:Job&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">cleanup</span><span class="p">(</span><span class="nv">$days</span><span class="p">);</span>

        <span class="nv">$output</span><span class="o">-&gt;</span><span class="na">writeln</span><span class="p">(</span><span class="nb">sprintf</span><span class="p">(</span><span class="s1">&#39;Removed %d stale jobs&#39;</span><span class="p">,</span> <span class="nv">$nb</span><span class="p">));</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The task removes all expired jobs from the index and then optimizes it thanks to the Zend Lucene built-in optimize() method.
Along this day, we implemented a full search engine with many features in less than an hour. Every time you want to add a new feature to your projects, check that it has not yet been solved somewhere else.
Tomorrow we will use some unobtrusive JavaScripts to enhance the responsiveness of the search engine by updating the results in real-time as the user types in the search box. Of course, this will be the occasion to talk about how to use AJAX with symfony.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<a class="reference external image-reference" href="http://creativecommons.org/licenses/by-sa/3.0/deed.ja"><img alt="Creative Commons License" class="align-left" src="http://i.creativecommons.org/l/by-sa/3.0/88x31.png" /></a>
<p class="last">This work is licensed under a Creative Commons Attribution-ShareAlike 3.0 Unported License.
original <cite>symfony2 jobeet</cite> article is here <a class="reference external" href="http://www.intelligentbee.com/blog/tag/symfony2-jobeet/">http://www.intelligentbee.com/blog/tag/symfony2-jobeet/</a>.</p>
</div>
</div>
</div>


    </div>
      
  </div>
</div>
<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'symfony2jobeetja'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

  
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2014, yositani2002.<br/>
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.2.2.<br/>
    </p>
  </div>
</footer>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-51733398-2', 'auto');
  ga('send', 'pageview');

</script>
 <script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'symfony2jobeetja'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
    </script>


  </body>
</html>